@startuml

box "User process" 
    actor "user"
    participant "HealthMonitorBuilder"
    participant "HealthMonitor"
    participant "Lifecycle"
end box

box "LaunchDaemon process"
    participant "LaunchDaemon"
end box

== Application Side ==

user -> HealthMonitorBuilder : build(supervisor_api_notification_cycle_time, ...)
HealthMonitorBuilder -> HealthMonitor: create
HealthMonitor -> LaunchDaemon: register_health_monitor(supervisor_api_notification_cycle_time, ...)
note left
All configuration needed can be send here
end note

HealthMonitorBuilder --> user: HealthMonitor instance

user -> HealthMonitor: start()
HealthMonitor -> LaunchDaemon: notify_started(timestamp)
HealthMonitor -> HealthMonitor: start_background_thread()
note left
Notification has to finish before background thread starts
to not race with lifecycle api.
end note
...

user -> Lifecycle: report_running()
Lifecycle -> LaunchDaemon


== LaunchDaemon Side ==

...
alt APPLICATION_USES_LIFECYCLE_API
    user -> Lifecycle: report_running()
    Lifecycle -> LaunchDaemon

    LaunchDaemon -> LaunchDaemon: check_if_register_was_received()
    alt not received
        LaunchDaemon -> LaunchDaemon: error_reaction()
    end

    LaunchDaemon -> LaunchDaemon: check_if_notify_started_was_received()
    alt not received
        LaunchDaemon -> LaunchDaemon: error_reaction()
    end


    LaunchDaemon -> LaunchDaemon: start_monitor_user_application()
    note left
    Here we start monitoring application with provided configuration means
    from now one we check cyclically if application is alive.

    **HINT**
    If we want faster reaction on start we can check also **timestamp** from
    notify_started to fail immediately if it already expired.
    end note
else NO_RUNNING_REPORTED_FOR_STARTED_APPLICATION
    note left of LaunchDaemon
    Since we started user application we know whom we expect
    to report/not report state.
    end note

    alt app config explicitly excludes lifecycle API
        LaunchDaemon -> LaunchDaemon: ignore_monitoring_of_app()
        note left
        We do not monitor application since it explicitly excluded lifecycle API usage.
        This should mean we also check that it was not registered by HealthMonitor otherwise
        it shall be an error.
        **QUESTION**
        Do we need more complex logics that can exclude monitoring and allow lifecycle ?
        end note
    else
        LaunchDaemon -> LaunchDaemon: error_reaction()
    end
end

@enduml
